---
title: "census_data_temp"
output: html_document
---

```{r}
library(tidycensus)
library(tidyverse)
library(viridis)
library(data.table)
library(dplyr)
```

# Merge three levels and filter UHF > 15

Note: The observation changes from 1344 to 1211 after filtering.

```{r}
dat_merged_1 <- read.csv("./dat_merged_1.csv")
modzcta_zip_counts <- read.csv("./modzcta_zip_counts.csv")
uhf_ids <- c(104, 105, 205, 207, 208, 211, 301, 303, 304, 306, 309, 310, 401, 405, 407, 408, 501, 502)

merged_data <- merge(dat_merged_1, modzcta_zip_counts[, c("ZCTA_str", "zip_code")], 
                     by.x = "zipcode", by.y = "zip_code", all.x = TRUE) %>%
  select(ResponseId, zipcode, ZCTA_str, UHF_id, UHF_name, everything()) %>%
  filter(UHF_id %in% uhf_ids)

write.csv(merged_data, file = "merged_output.csv", row.names = FALSE)
```

# Download Data

```{r}
census_api_key("919b37e63df029d1420900f893770f49d4a03226")
v21 <- load_variables(2021, "acs5", cache = TRUE)
write_csv(v21, './variable_namesv21.csv')
zcta_ls <- unique(merged_data$ZCTA_str)
```

## Population

Note: See "hf_population_summary.csv" file.

```{r}
race_group_popu <- c(
  'B01001A_001',
  'B01001B_001',
  'B01001C_001',
  'B01001D_001',
  'B01001E_001',
  'B01001F_001',
  'B01001G_001'
)

population <- get_acs(geography = "zcta",
                      variables = race_group_popu,
                      year = 2021,
                      zcta = zcta_ls,
                      moe_level = 90,
                      survey = "acs5") %>%
    select('GEOID','variable','estimate') %>%
    pivot_wider(names_from = variable,
                values_from = estimate,
                names_sep = "_") %>%
    mutate(Total_Estimate = rowSums(select(.,2:8),na.rm=TRUE)) %>%
    select(GEOID, Population = Total_Estimate)

merged_with_pop <- merge(merged_data, population, 
                         by.x = "ZCTA_str", by.y = "GEOID", 
                         all.x = TRUE)

uhf_population_summary <- merged_with_pop %>%
  group_by(UHF_id) %>%
  summarise(total_population = sum(Population, na.rm = TRUE))

write.csv(uhf_population_summary, file = "uhf_population_summary.csv", row.names = FALSE)
```

