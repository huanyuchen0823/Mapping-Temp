---
title: "census_data_temp"
output: html_document
---

```{r}
library(tidycensus)
library(tidyverse)
library(viridis)
library(data.table)
library(dplyr)
```

# Merge three levels for survey data

```{r}
dat_merged_1 <- read.csv("./1_output/dat_merged_1.csv")
modzcta_zip_counts <- read.csv("./0_prepare/modzcta_zip_counts.csv")
zipcode_uhf_mapping <- read.csv("./0_prepare/zipcode_uhf_mapping.csv")
# filter
# uhf_ids <- c(104, 105, 205, 207, 208, 211, 301, 303, 304, 306, 309, 310, 401, 405, 407, 408, 501, 502)

merged_data <- merge(dat_merged_1, modzcta_zip_counts[, c("ZCTA_str", "zip_code")], 
                     by.x = "zipcode", by.y = "zip_code", all.x = TRUE) %>%
  select(ResponseId, zipcode, ZCTA_str, UHF_id, UHF_name, everything())
  # filter(UHF_id %in% uhf_ids)

write.csv(merged_data, file = "2_output/merged_output.csv", row.names = FALSE)

mapping_guide_temp <- merge(modzcta_zip_counts, zipcode_uhf_mapping, by = "zip_code", all.x = TRUE)

mapping_guide <- mapping_guide_temp %>%
  select(ZCTA, UHF_id, zip_code) %>%
  filter(!is.na(UHF_id))

write.csv(mapping_guide, file = "2_output/mapping_guide.csv", row.names = FALSE)
```

# Download Data

```{r}
census_api_key("919b37e63df029d1420900f893770f49d4a03226")
v21 <- load_variables(2021, "acs5", cache = TRUE)
write_csv(v21, './2_output/variable_namesv21.csv')
zcta_ls <- unique(modzcta_zip_counts$ZCTA)
```

## Population

```{r}
race_group_popu <- c(
  'B01001A_001',
  'B01001B_001',
  'B01001C_001',
  'B01001D_001',
  'B01001E_001',
  'B01001F_001',
  'B01001G_001'
)

population <- get_acs(geography = "zcta",
                      variables = race_group_popu,
                      year = 2021,
                      zcta = zcta_ls,
                      moe_level = 90,
                      survey = "acs5") %>%
    select('GEOID','variable','estimate') %>%
    pivot_wider(names_from = variable,
                values_from = estimate,
                names_sep = "_") %>%
    mutate(Total_Estimate = rowSums(select(.,2:8),na.rm=TRUE)) %>%
    select(GEOID, Population = Total_Estimate)

merged_pop <- merge(mapping_guide, population, 
                    by.x = "ZCTA", by.y = "GEOID", 
                    all.x = TRUE)

uhf_pop_summary <- merged_pop %>%
  distinct(ZCTA, .keep_all = TRUE) %>%
  group_by(UHF_id) %>%
  summarise(total_population = sum(Population, na.rm = TRUE))

# write.csv(uhf_pop_summary, file = "2_output/uhf_pop_summary.csv", row.names = FALSE)
```

# NO HEALTH INSURANCE

```{r}
rows_with_no_insurance <- v21[grep("No health insurance coverage", v21$label), ]
sub_no_insurance <- rows_with_no_insurance[rows_with_no_insurance$concept ==
                                             "HEALTH INSURANCE COVERAGE STATUS BY SEX BY AGE",]
nohealthinsurance_groups <- sub_no_insurance$name
ls <- length(nohealthinsurance_groups)+1

no_health_insurance <- get_acs(geography = "zcta",
                    variables = nohealthinsurance_groups,
                    year = 2021,
                    zcta = zcta_ls,
                    moe_level = 90,
                    survey = "acs5") %>%
    select('GEOID','variable','estimate') %>%
    pivot_wider(names_from = variable,
                values_from = estimate,
                names_sep = "_") %>%
    mutate(Total_Estimate = rowSums(select(.,2:ls), na.rm = TRUE)) %>%
    select(GEOID, No_health_insurance = Total_Estimate)

merged <- merge(merged_pop, no_health_insurance,
                by.x = "ZCTA", by.y = "GEOID", 
                all.x = TRUE)

uhf_summary <- merged %>%
  distinct(ZCTA, .keep_all = TRUE) %>%
  group_by(UHF_id) %>%
  summarise(total_population = sum(Population, na.rm = TRUE),
            total_no_health_insurance = sum(No_health_insurance, na.rm = TRUE))

# Back-Up
# merged_with_no_health <- merge(merged_with_pop, no_health_insurance, 
#                          by.x = "ZCTA_str", by.y = "GEOID", 
#                          all.x = TRUE)
# 
# uhf_no_health_summary <- merged_with_no_health %>%
#   distinct(ZCTA_str, .keep_all = TRUE) %>%
#   group_by(UHF_id) %>%
#   summarise(
#     total_population = sum(Population, na.rm = TRUE),
#     total_no_health_insurance = sum(No_health_insurance, na.rm = TRUE)
#   )
```

# Education

```{r}
bachelor <- get_acs(geography = "zcta",
                    variables = 'B06009_005',
                    year = 2021,
                    zcta = zcta_ls,
                    moe_level = 90,
                    survey = "acs5") %>%
    select(GEOID, Bachelor = estimate)

merged <- merge(merged, bachelor,
                by.x = "ZCTA", by.y = "GEOID", 
                all.x = TRUE)

uhf_summary <- merged %>%
  distinct(ZCTA, .keep_all = TRUE) %>%
  group_by(UHF_id) %>%
  summarise(total_population = sum(Population, na.rm = TRUE),
            total_no_health_insurance = sum(No_health_insurance, na.rm = TRUE),
            total_bachelor = sum(Bachelor, na.rm = TRUE))
```

# Household Income

```{r}
householdincome <- get_acs(geography = "zcta",
                    variables = 'B19019_001',
                    year = 2021,
                    zcta = zcta_ls,
                    moe_level = 90,
                    survey = "acs5") %>%
    select(GEOID, Household_income = estimate)

merged <- merge(merged, householdincome,
                by.x = "ZCTA", by.y = "GEOID", 
                all.x = TRUE)

uhf_summary <- merged %>%
  distinct(ZCTA, .keep_all = TRUE) %>%
  group_by(UHF_id) %>%
  summarise(total_population = sum(Population, na.rm = TRUE),
            total_no_health_insurance = sum(No_health_insurance, na.rm = TRUE),
            total_bachelor = sum(Bachelor, na.rm = TRUE),
            total_householdincome = sum(Household_income, na.rm = TRUE)
  )
```

# Household Number

```{r}
householdnum <- get_acs(geography = "zcta",
                    variables = "B08201_001",
                    year = 2021,
                    zcta = zcta_ls,
                    moe_level = 90,
                    survey = "acs5") %>%
    select(GEOID, Household_num = estimate)

merged <- merge(merged, householdnum,
                by.x = "ZCTA", by.y = "GEOID", 
                all.x = TRUE)

uhf_summary <- merged %>%
  distinct(ZCTA, .keep_all = TRUE) %>%
  group_by(UHF_id) %>%
  summarise(total_population = sum(Population, na.rm = TRUE),
            total_no_health_insurance = sum(No_health_insurance, na.rm = TRUE),
            total_bachelor = sum(Bachelor, na.rm = TRUE),
            total_householdincome = sum(Household_income, na.rm = TRUE),
            total_householdnum = sum(Household_num, na.rm = TRUE)
  )
```

# No Vehicles

```{r}
no_vehicles <- get_acs(geography = "zcta",
                    variables = "B08201_002",
                    year = 2021,
                    zcta = zcta_ls,
                    moe_level = 90,
                    survey = "acs5") %>%
    select(GEOID, No_vehicles = estimate)

merged <- merge(merged, no_vehicles,
                by.x = "ZCTA", by.y = "GEOID", 
                all.x = TRUE)

uhf_summary <- merged %>%
  distinct(ZCTA, .keep_all = TRUE) %>%
  group_by(UHF_id) %>%
  summarise(total_population = sum(Population, na.rm = TRUE),
            total_no_health_insurance = sum(No_health_insurance, na.rm = TRUE),
            total_bachelor = sum(Bachelor, na.rm = TRUE),
            total_householdincome = sum(Household_income, na.rm = TRUE),
            total_householdnum = sum(Household_num, na.rm = TRUE),
            total_no_vehicles = sum(No_vehicles, na.rm = TRUE)
  )
```

# Age
```{r}
ageunder25_groups <- c(
  # Group 1
  'B01001B_003', 'B01001B_018',
  'B01001C_003', 'B01001C_018',
  'B01001D_003', 'B01001D_018',
  'B01001E_003', 'B01001E_018',
  'B01001F_003', 'B01001F_018',
  'B01001G_003', 'B01001G_018',
  'B01001H_003', 'B01001H_018',
  'B01001I_003', 'B01001I_018',
  
  # Group 2
  'B01001B_004', 'B01001B_019',
  'B01001C_004', 'B01001C_019',
  'B01001D_004', 'B01001D_019',
  'B01001E_004', 'B01001E_019',
  'B01001F_004', 'B01001F_019',
  'B01001G_004', 'B01001G_019',
  'B01001H_004', 'B01001H_019',
  'B01001I_004', 'B01001I_019',
  
  # Group 3
  'B01001B_005', 'B01001B_020',
  'B01001C_005', 'B01001C_020',
  'B01001D_005', 'B01001D_020',
  'B01001E_005', 'B01001E_020',
  'B01001F_005', 'B01001F_020',
  'B01001G_005', 'B01001G_020',
  'B01001H_005', 'B01001H_020',
  'B01001I_005', 'B01001I_020',
  
  # Group 4
  'B01001B_006', 'B01001B_021',
  'B01001C_006', 'B01001C_021',
  'B01001D_006', 'B01001D_021',
  'B01001E_006', 'B01001E_021',
  'B01001F_006', 'B01001F_021',
  'B01001G_006', 'B01001G_021',
  'B01001H_006', 'B01001H_021',
  'B01001I_006', 'B01001I_021',
  
  # Group 5
  'B01001B_007', 'B01001B_022',
  'B01001C_007', 'B01001C_022',
  'B01001D_007', 'B01001D_022',
  'B01001E_007', 'B01001E_022',
  'B01001F_007', 'B01001F_022',
  'B01001G_007', 'B01001G_022',
  'B01001H_007', 'B01001H_022',
  'B01001I_007', 'B01001I_022',
  
  # Group 6
  'B01001B_008', 'B01001B_023',
  'B01001C_008', 'B01001C_023',
  'B01001D_008', 'B01001D_023',
  'B01001E_008', 'B01001E_023',
  'B01001F_008', 'B01001F_023',
  'B01001G_008', 'B01001G_023',
  'B01001H_008', 'B01001H_023',
  'B01001I_008', 'B01001I_023'
)

ls <- length(ageunder25_groups) + 1
ageunder25_groups <- get_acs(geography = "zcta",
                             variables = ageunder25_groups,
                             year = 2021,
                             zcta = zcta_ls,
                             moe_level = 90,
                             survey = "acs5") %>%
    select('GEOID','variable','estimate') %>%
    pivot_wider(names_from = variable,
                values_from = estimate,
                names_sep = "_") %>%
    mutate(Total_Estimate = rowSums(select(., 2:ls), na.rm = TRUE)) %>%
    select(GEOID, Ageunder25 = Total_Estimate)

merged <- merge(merged, ageunder25_groups,
                by.x = "ZCTA", by.y = "GEOID", 
                all.x = TRUE)

uhf_summary <- merged %>%
  distinct(ZCTA, .keep_all = TRUE) %>%
  group_by(UHF_id) %>%
  summarise(total_population = sum(Population, na.rm = TRUE),
            total_no_health_insurance = sum(No_health_insurance, na.rm = TRUE),
            total_bachelor = sum(Bachelor, na.rm = TRUE),
            total_householdincome = sum(Household_income, na.rm = TRUE),
            total_householdnum = sum(Household_num, na.rm = TRUE),
            total_no_vehicles = sum(No_vehicles, na.rm = TRUE),
            total_ageunder25 = sum(Ageunder25, na.rm = TRUE)
  )
```

