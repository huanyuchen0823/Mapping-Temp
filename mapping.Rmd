---
title: "Mapping Scores with Participant IDs into UHF"
author: "Huanyu Chen"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(readr)
library(dplyr)
```

```{r}
unique_item <- read_csv("./1_3_dat_unique_item.csv") %>%
  select(1, 2, score) %>% # td_score
  mutate(zipcode = substr(zipcode, 1, 5),
         td_score = score) %>%
  select(-score)

agency_scores <- read_csv("./agency_scores.csv") %>%
  mutate(agency_scores = rowSums(select(., 2:19), na.rm = TRUE)) %>%
  select(1, agency_scores)

dat_lossgain_scores <- read_csv("./dat_lossgain_scores.csv") %>%
  select(1, 10)

zipcode_uhf_mapping <- read_csv("./zipcode_uhf_mapping.csv") %>%
  select(1, 3, 4) %>%
  mutate(zipcode = as.character(zip_code)) %>%
  select(-zip_code)
```

```{r}
dat <- agency_scores %>%
  inner_join(unique_item, by = "ResponseId") %>%
  inner_join(dat_lossgain_scores, by = "ResponseId") %>%
  inner_join(zipcode_uhf_mapping, by = "zipcode") %>%
  distinct(ResponseId, .keep_all = TRUE)

# scale
scale_to_100 <- function(x, min_val, max_val) {
  round((x - min_val) * 100 / (max_val - min_val), 2)
}

agency_scores_min <- min(dat$agency_scores, na.rm = TRUE)
agency_scores_max <- max(dat$agency_scores, na.rm = TRUE)
td_score_min <- min(dat$td_score, na.rm = TRUE)
td_score_max <- max(dat$td_score, na.rm = TRUE)
loss_aversion_scores_min <- min(dat$loss_aversion_scores, na.rm = TRUE)
loss_aversion_scores_max <- max(dat$loss_aversion_scores, na.rm = TRUE)

dat <- dat %>%
  mutate(
    agency_scores_scaled = scale_to_100(agency_scores, agency_scores_min, agency_scores_max),
    td_score_scaled = scale_to_100(td_score, td_score_min, td_score_max),
    loss_aversion_scores_scaled = scale_to_100(loss_aversion_scores, loss_aversion_scores_min, loss_aversion_scores_max)) %>%
  select(ResponseId, zipcode, UHF_id, UHF_name, td_score, td_score_scaled,
         agency_scores, agency_scores_scaled, loss_aversion_scores, loss_aversion_scores_scaled)

write_csv(dat, "dat_merged_1.csv")
```

```{r}
summary_data <- dat %>%
  group_by(UHF_id, UHF_name) %>%
  summarise(ParticipantCount = n())

write_csv(summary_data, "dat_merge_2_UHF.csv")

filtered_data <- summary_data %>%
  filter(ParticipantCount >= 15)

write_csv(filtered_data, "dat_merge_3_UHF>=15.csv")
```

Note: total # of observation = 1211.
